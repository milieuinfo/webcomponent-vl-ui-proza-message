<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <script src="../../node_modules/@webcomponents/webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../node_modules/web-component-tester/browser.js"></script>
  <script src="../../node_modules/sinon/pkg/sinon.js"></script>
  <script src="../../node_modules/sinon-chai/lib/sinon-chai.js"></script>

  <script type="module" src="../../vl-proza-message.src.js"></script>
</head>

<body>
  <test-fixture id="vl-proza-messages-fixture">
    <template>
      <div>
        <vl-proza-message id="message-1" data-vl-domain="foo" data-vl-code="bar"></vl-proza-message>
        <vl-proza-message id="message-2" data-vl-domain="foo" data-vl-code="bar"></vl-proza-message>
      </div>
    </template>
  </test-fixture>

  <script type="module">
    import { VlProzaMessage, VlProzaMessagePreloader } from '../../vl-proza-message.src.js';
    import { awaitUntil } from 'vl-ui-core/vl-core';
    import fetchMock from 'fetch-mock/esm/client.mjs';

    suite('vl-proza-message', () => {
      const should = chai.should();
      const sandbox = sinon.createSandbox();

      setup(() => {
        fetchMock.mock('proza/domein/foo/bar', { code: "bar", tekst: "foobar" });
        fetchMock.mock('proza/domein/foo/toegelatenoperaties', { update: true });
      });

      teardown(() => {
        sandbox.restore();
        fetchMock.restore();
        delete VlProzaMessage.__cache;
        delete VlProzaMessagePreloader.__cache;
      });

      function prozaMessageContent(message) {
        return message.shadowRoot.querySelector('#content').textContent;
      }

      function prozaMessageEditButton(message) {
        return message.shadowRoot.querySelector('button');
      }

      function prozaMessageEditButtonIcon(button) {
        return button.querySelector('[is="vl-icon"]').getAttribute('icon');
      }

      test('toont een bericht', () => {
        const proza = fixture('vl-proza-messages-fixture');
        return fetchMock.flush(true).then(() => {
          return awaitUntil(() => {
            return prozaMessageContent(proza.querySelector('#message-1')) === 'foobar' &&
                    prozaMessageContent(proza.querySelector('#message-2')) === 'foobar';
          });
        });
      });

      test('bevat de mogelijkheid om de content te wijzigen indien de wijzig operatie toegelaten is', () => {
        const proza = fixture('vl-proza-messages-fixture');
        return fetchMock.flush(true).then(() => {
          const button1 = prozaMessageEditButton(proza.querySelector('#message-1'));
          const icon1 = prozaMessageEditButtonIcon(button1);
          should.exist(button1);
          icon1.should.equal('edit');

          const button2 = prozaMessageEditButton(proza.querySelector('#message-2'));
          const icon2 = prozaMessageEditButtonIcon(button2);
          should.exist(button2);
          icon2.should.equal('edit');
        });
      });

      test('bevat niet de mogelijkheid om de content te wijzigen indien de wijzig operatie niet toegelaten is', () => {
        fetchMock.mock('proza/domein/foo/toegelatenoperaties', { update: false }, { overwriteRoutes: true });

        const proza = fixture('vl-proza-messages-fixture');
        return fetchMock.flush(true).then(() => {
          should.not.exist(prozaMessageEditButton(proza.querySelector('#message-1')));
          should.not.exist(prozaMessageEditButton(proza.querySelector('#message-2')));
        });
      });

      test('er wordt een error gelogd indien er iets fout loopt bij het ophalen van een proza bericht', () => {
        sandbox.spy(console, 'error');
        fetchMock.mock('proza/domein/foo/bar', 404, { overwriteRoutes: true });

        const proza = fixture('vl-proza-messages-fixture');
        return fetchMock.flush(true).then(() => {
          prozaMessageContent(proza.querySelector('#message-1')).should.equal('');
          prozaMessageContent(proza.querySelector('#message-2')).should.equal('');
          console.error.should.be.called;
        });
      });

      test('er wordt een error gelogd indien er iets fout loopt bij het ophalen van de toegelaten operaties', () => {
        sandbox.spy(console, 'error');
        fetchMock.mock('proza/domein/foo/toegelatenoperaties', 404, { overwriteRoutes: true });

        const proza = fixture('vl-proza-messages-fixture');
        return fetchMock.flush(true).then(() => {
          should.not.exist(prozaMessageEditButton(proza.querySelector('#message-1')));
          should.not.exist(prozaMessageEditButton(proza.querySelector('#message-2')));
          console.error.should.be.called;
        });
      });

      test('haalt het bericht en de toegelaten operaties maar 1 keer op indien deze al in de cache zitten', () => {
        fixture('vl-proza-messages-fixture');
        return fetchMock.flush(true).then(() => {
          fetchMock.calls('proza/domein/foo/bar').length.should.equal(1);
          fetchMock.calls('proza/domein/foo/toegelatenoperaties').length.should.equal(1);
        });
      });

      test('het aanpassen van het data-vl-code attribuut zal ervoor zorgen dat het bericht voor die code getoond wordt', () => {
        fetchMock.mock('proza/domein/foo/foo', { code: "foo", tekst: "foofoo" });

        const proza = fixture('vl-proza-messages-fixture');
        const message1 = proza.querySelector('#message-1');
        message1.dataset.vlCode = 'foo';
        return fetchMock.flush(true).then(() => {
          return awaitUntil(() => {
            return prozaMessageContent(proza.querySelector('#message-1')) === 'foofoo';
          });
        });
      });

      test('het aanpassen van het data-vl-domain attribuut zal ervoor zorgen dat het bericht voor dat domein getoond wordt', () => {
        fetchMock.mock('proza/domein/bar/bar', { code: "bar", tekst: "barbar" });

        const proza = fixture('vl-proza-messages-fixture');
        const message1 = proza.querySelector('#message-1');
        message1.dataset.vlDomain = 'bar';
        return fetchMock.flush(true).then(() => {
          return awaitUntil(() => {
            return prozaMessageContent(proza.querySelector('#message-1')) === 'barbar';
          });
        });
      });
    });
  </script>
</body>

</html>